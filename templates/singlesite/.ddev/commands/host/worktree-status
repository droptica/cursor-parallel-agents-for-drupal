#!/bin/bash

## Description: Show status of Cursor worktree DDEV projects
## Usage: worktree-status
## Example: ddev worktree-status

set -e

PROJECT_PREFIX="__PROJECT_NAME__-"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

echo ""
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${CYAN}  Cursor Worktree Status${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Find worktree DDEV projects
WORKTREE_CONTAINERS=$(docker ps --format '{{.Names}}' 2>/dev/null | grep "ddev-${PROJECT_PREFIX}" | sed 's/-web$//' | sort -u || echo "")

if [[ -z "$WORKTREE_CONTAINERS" ]]; then
  echo -e "${BLUE}[INFO]${NC} No active worktree DDEV projects found"
  echo ""
  exit 0
fi

echo -e "${GREEN}Active worktree projects:${NC}"
echo ""

echo "$WORKTREE_CONTAINERS" | while read -r container; do
  if [[ -z "$container" ]]; then
    continue
  fi

  PROJECT_NAME="${container#ddev-}"
  WORKTREE_ID="${PROJECT_NAME#${PROJECT_PREFIX}}"

  # Get container status
  WEB_STATUS=$(docker ps --filter "name=${container}-web" --format "{{.Status}}" 2>/dev/null | head -1 || echo "unknown")
  DB_STATUS=$(docker ps --filter "name=${container}-db" --format "{{.Status}}" 2>/dev/null | head -1 || echo "unknown")

  echo -e "  ${CYAN}▶${NC} ${PROJECT_NAME}"
  echo -e "    Worktree ID: ${WORKTREE_ID}"
  echo -e "    URL: https://${PROJECT_NAME}.ddev.site"
  echo -e "    Web: ${WEB_STATUS}"
  echo -e "    DB: ${DB_STATUS}"
  echo ""
done

# Show Git worktrees
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${CYAN}  Git Worktrees${NC}"
echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

git worktree list 2>/dev/null || echo "Not a Git repository"

echo ""
echo -e "${YELLOW}Tip:${NC} Run '.cursor/cleanup-worktree.sh --all' to stop all worktree projects"
echo ""
